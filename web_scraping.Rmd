---
title: "Exmple working document of parsing clinical data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(httr)
library(jsonlite)
library(tibble)
```

## Getting data from clinicaltrials.gov

- I got the dataset out from clinicaltrials.gov webpage in to the data.frame. 

- I can make a data frame out of returned json.

- But I have still problems with the variables, which have a data frame or list inside. 

- What else? Check how to get right data from clinicaltrials.gov...API request is not right


### Example of 100 trials from finland

```{r}
url <- "https://clinicaltrials.gov/api/query/full_studies?expr=finland&min_rnk=1&max_rnk=100&fmt=json"
res <- fromJSON(content(GET(url)))
df <- as_tibble(res$FullStudiesResponse$FullStudies)
trials <- dplyr::tibble(
  NCTId = df$Study$ProtocolSection$IdentificationModule$NCTId, ## id
  BriefTitle = df$Study$ProtocolSection$IdentificationModule$BriefTitle, ## title
  OfficialTitle = df$Study$ProtocolSection$IdentificationModule$OfficialTitle,
  df$Study$ProtocolSection$IdentificationModule$Acronym,
  df$Study$ProtocolSection$IdentificationModule$Organization$OrgFullName,
  OrgClass = df$Study$ProtocolSection$IdentificationModule$Organization$OrgClass,
  # =
  StartDate=df$Study$ProtocolSection$StatusModule$StartDateStruct$StartDate,
  StartDateType=df$Study$ProtocolSection$StatusModule$StartDateStruct$StartDateType,
  PrimaryCompletionDate=df$Study$ProtocolSection$StatusModule$PrimaryCompletionDateStruct$PrimaryCompletionDate,
  PrimaryCompletionDateType=df$Study$ProtocolSection$StatusModule$PrimaryCompletionDateStruct$PrimaryCompletionDateType,
  # =
  LastKnownStatus=df$Study$ProtocolSection$StatusModule$LastKnownStatus,
  # =
  ResponsiblePartyType=df$Study$ProtocolSection$SponsorCollaboratorsModule$ResponsibleParty$ResponsiblePartyType,
  ResponsiblePartyInvestigatorFullName=df$Study$ProtocolSection$SponsorCollaboratorsModule$ResponsibleParty$ResponsiblePartyInvestigatorFullName,
  ResponsiblePartyInvestigatorTitle=df$Study$ProtocolSection$SponsorCollaboratorsModule$ResponsibleParty$ResponsiblePartyInvestigatorTitle,
  ResponsiblePartyInvestigatorAffiliation=df$Study$ProtocolSection$SponsorCollaboratorsModule$ResponsibleParty$ResponsiblePartyInvestigatorAffiliation,
  # =
  LeadSponsorName=df$Study$ProtocolSection$SponsorCollaboratorsModule$LeadSponsor$LeadSponsorName,
  LeadSponsorClass=df$Study$ProtocolSection$SponsorCollaboratorsModule$LeadSponsor$LeadSponsorClass,
  # =
  # df$Study$ProtocolSection$SponsorCollaboratorsModule$CollaboratorList$Collaborator # df
  # =
  BriefSummary=df$Study$ProtocolSection$DescriptionModule$BriefSummary,
  DetailedDescription=df$Study$ProtocolSection$DescriptionModule$DetailedDescription,
  # =
  Condition=df$Study$ProtocolSection$ConditionsModule$ConditionList$Condition, #df
  Keyword=df$Study$ProtocolSection$ConditionsModule$KeywordList$Keyword,   # df
  # =
  StudyType=df$Study$ProtocolSection$DesignModule$StudyType,
  Phase=df$Study$ProtocolSection$DesignModule$PhaseList$Phase,
  # =
  EligibilityCriteria=df$Study$ProtocolSection$EligibilityModule$EligibilityCriteria,
  HealthyVolunteers=df$Study$ProtocolSection$EligibilityModule$HealthyVolunteers,
  Gender=df$Study$ProtocolSection$EligibilityModule$Gender,
  MinimumAge=df$Study$ProtocolSection$EligibilityModule$MinimumAge,
  MaximumAge=df$Study$ProtocolSection$EligibilityModule$MaximumAge,
  StudyPopulation=df$Study$ProtocolSection$EligibilityModule$StudyPopulation,
  SamplingMethod=df$Study$ProtocolSection$EligibilityModule$SamplingMethod,
  GenderBased=df$Study$ProtocolSection$EligibilityModule$GenderBased,
  GenderDescription=df$Study$ProtocolSection$EligibilityModule$GenderDescription,
  # =
  # OverallOfficial=df$Study$ProtocolSection$ContactsLocationsModule$OverallOfficialList$OverallOfficial,
  # Location=df$Study$ProtocolSection$ContactsLocationsModule$LocationList$Location,
  # CentralContact=df$Study$ProtocolSection$ContactsLocationsModule$CentralContactList$CentralContact,
  # =
  Reference=df$Study$ProtocolSection$ReferencesModule$ReferenceList$Reference,
  SeeAlsoLink=df$Study$ProtocolSection$ReferencesModule$SeeAlsoLinkList$SeeAlsoLink
)

DT::datatable(trials)
```

## How to extrack Collaborator List

```{r eval=FALSE}
temp <- df$Study$ProtocolSection$SponsorCollaboratorsModule$CollaboratorList$Collaborator


lapply(df$Study$ProtocolSection$SponsorCollaboratorsModule$CollaboratorList$Collaborator, function(CollaboratorName) print(paste0(CollaboratorName)))

structure(df$Study$ProtocolSection$SponsorCollaboratorsModule$CollaboratorList$Collaborator)
df$Study$ProtocolSection$SponsorCollaboratorsModule$CollaboratorList$Collaborator[["CollaboratorName"]]

unlist(df$Study$ProtocolSection$SponsorCollaboratorsModule$CollaboratorList$Collaborator)
x <- unlist(df$Study$ProtocolSection$SponsorCollaboratorsModule$CollaboratorList$Collaborator)
x["CollaboratorName"]
```

## How to extract Location

```{r, eval=FALSE}
unlist(df$Study$ProtocolSection$ContactsLocationsModule$LocationList$Location)

df$Study$ProtocolSection$ContactsLocationsModule$LocationList$Location["LocationCity"]

df$Study$ProtocolSection$ContactsLocationsModule$LocationList$Location[4]
df$Study$ProtocolSection$ContactsLocationsModule$LocationList$Location[1, c("LocationCity")]

as.data.frame(df$Study$ProtocolSection$ContactsLocationsModule$LocationList$Location[4])$LocationFacility
## yhdellä "rivillä" voi olla dataframessa useampi location tieto eli silloin sillä on oma df
## miten nämä pitäisi jäsentää?

paste0(as.data.frame(df$Study$ProtocolSection$ContactsLocationsModule$LocationList$Location)$LocationFacility)
```

